<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Din√°mico - Multi Marcadores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- LIBRERIAS AR.js -->
  <script src="../js/aframe.min.js"></script>
  <script src="../js/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    .arjs-loader {
      position: absolute;
      z-index: 999;
      background: rgba(0,0,0,0.9);
      color: white;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.3rem;
      flex-direction: column;
    }

    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: Arial;
      font-size: 12px;
      z-index: 100;
      max-width: 200px;
    }
  </style>
</head>

<body>

<div class="arjs-loader" id="loader">
  <div>üéØ Cargando Realidad Aumentada...</div>
  <div id="marker-count" style="margin-top: 10px; font-size: 1rem;"></div>
</div>

<div id="info">
  üì± Apunta a tus marcadores descargados<br>
  <span id="active-markers">0 marcadores activos</span>
</div>

<a-scene
  embedded
  vr-mode-ui="enabled: false"
  renderer="logarithmicDepthBuffer: true; precision: medium;"
  arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; patternRatio: 0.75;"
  id="scene"
>

  <a-assets id="assets" timeout="10000">
    <!-- Las im√°genes se cargar√°n din√°micamente aqu√≠ -->
  </a-assets>

  <!-- Los marcadores se generar√°n din√°micamente aqu√≠ -->

  <a-entity camera></a-entity>

</a-scene>

<script>
  let markers = [];
  let scene;
  let assetsEl;
  let activeMarkers = new Set();

  // Ocultar loader cuando est√© listo
  window.addEventListener('load', () => {
    setTimeout(() => {
      const loader = document.getElementById('loader');
      if (loader) {
        loader.style.display = 'none';
      }
    }, 3000);
  });

  // Cargar marcadores
  function loadMarkers() {
    const storedMarkers = localStorage.getItem('ar_user_markers');
    
    if (storedMarkers) {
      markers = JSON.parse(storedMarkers);
      console.log('üì¶ Marcadores cargados:', markers);
      document.getElementById('marker-count').textContent = `${markers.length} marcador(es) disponible(s)`;
      
      if (markers.length > 0) {
        generateMarkers();
      }
    } else {
      document.getElementById('marker-count').textContent = 'No hay marcadores. Sube im√°genes primero.';
    }
  }

  // Generar marcadores din√°micamente - CADA UNO INDEPENDIENTE CON PATTERN
  function generateMarkers() {
    scene = document.getElementById('scene');
    assetsEl = document.getElementById('assets');

    markers.forEach((marker, index) => {
      console.log(`üéØ Creando marcador ${index + 1}:`, marker.name);

      // 1. Agregar imagen a assets
      const imgAsset = document.createElement('img');
      imgAsset.setAttribute('id', `img-${marker.id}`);
      imgAsset.setAttribute('src', marker.imageUrl);
      imgAsset.setAttribute('crossorigin', 'anonymous');
      assetsEl.appendChild(imgAsset);

      // 2. Crear entidad del marcador usando DIFERENTES tipos
      const markerEntity = document.createElement('a-marker');
      
      // Estrategia: Usar diferentes marcadores preset REALES de AR.js
      // Estos marcadores S√ç funcionan y se pueden detectar simult√°neamente
      const presetMarkers = ['hiro', 'kanji'];
      
      if (index < presetMarkers.length) {
        // Usar marcadores preset para los primeros dos
        markerEntity.setAttribute('preset', presetMarkers[index]);
        console.log(`üìå Marcador ${index + 1} usa preset: ${presetMarkers[index]}`);
      } else {
        // Para marcadores adicionales, usar barcode con diferentes valores
        const barcodeValue = index - presetMarkers.length;
        markerEntity.setAttribute('type', 'barcode');
        markerEntity.setAttribute('value', barcodeValue.toString());
        console.log(`üìå Marcador ${index + 1} usa barcode: ${barcodeValue}`);
      }
      
      markerEntity.setAttribute('id', `marker-${marker.id}`);
      markerEntity.setAttribute('smooth', 'true');
      markerEntity.setAttribute('smoothCount', '10');
      markerEntity.setAttribute('smoothTolerance', '0.01');
      markerEntity.setAttribute('smoothThreshold', '5');
      markerEntity.setAttribute('raycaster', 'objects: .clickable');

      // 3. Crear contenedor del contenido 3D
      const contentEntity = document.createElement('a-entity');
      contentEntity.setAttribute('id', `content-${marker.id}`);
      contentEntity.setAttribute('visible', 'false'); // Oculto por defecto

      // 4. Crear plano con la imagen
      const plane = document.createElement('a-plane');
      plane.setAttribute('src', `#img-${marker.id}`);
      plane.setAttribute('width', '1.5');
      plane.setAttribute('height', '1.5');
      plane.setAttribute('rotation', '-90 0 0');
      plane.setAttribute('position', '0 0 0');
      plane.setAttribute('material', 'transparent: true; alphaTest: 0.2; shader: flat;');
      plane.setAttribute('class', 'clickable');
      
      // Animaci√≥n flotante
      plane.setAttribute('animation__float', 
        'property: position; ' +
        'to: 0 0.5 0; ' +
        'dur: 2000; ' +
        'easing: easeInOutSine; ' +
        'loop: true; ' +
        'dir: alternate; ' +
        'startEvents: markerFound'
      );

      // Animaci√≥n de rotaci√≥n
      plane.setAttribute('animation__rotate',
        'property: rotation; ' +
        'to: -90 360 0; ' +
        'dur: 8000; ' +
        'easing: linear; ' +
        'loop: true; ' +
        'startEvents: markerFound'
      );

      // Animaci√≥n de escala al aparecer
      plane.setAttribute('animation__scale',
        'property: scale; ' +
        'from: 0.1 0.1 0.1; ' +
        'to: 1 1 1; ' +
        'dur: 800; ' +
        'easing: easeOutElastic; ' +
        'startEvents: markerFound'
      );

      contentEntity.appendChild(plane);

      // 5. Agregar texto con el nombre
      const text = document.createElement('a-text');
      text.setAttribute('value', marker.name.toUpperCase());
      text.setAttribute('align', 'center');
      text.setAttribute('color', '#00FF00');
      text.setAttribute('width', '2.5');
      text.setAttribute('position', '0 -1 0');
      text.setAttribute('rotation', '-90 0 0');
      text.setAttribute('shader', 'flat');
      
      // Animaci√≥n de brillo del texto
      text.setAttribute('animation__glow',
        'property: components.text.material.color; ' +
        'from: #00FF00; ' +
        'to: #FFFFFF; ' +
        'dur: 1500; ' +
        'easing: easeInOutSine; ' +
        'loop: true; ' +
        'dir: alternate; ' +
        'startEvents: markerFound'
      );
      
      contentEntity.appendChild(text);

      // 6. Agregar part√≠culas/efectos alrededor
      for (let i = 0; i < 4; i++) {
        const particle = document.createElement('a-sphere');
        const angle = (i / 4) * Math.PI * 2;
        const radius = 1;
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;
        
        particle.setAttribute('radius', '0.05');
        particle.setAttribute('color', '#4CAF50');
        particle.setAttribute('position', `${x} 0.2 ${z}`);
        particle.setAttribute('material', 'shader: flat; emissive: #4CAF50; emissiveIntensity: 0.5;');
        
        particle.setAttribute('animation__orbit',
          `property: position; ` +
          `to: ${-x} 0.2 ${-z}; ` +
          `dur: ${3000 + i * 500}; ` +
          `easing: linear; ` +
          `loop: true; ` +
          `dir: alternate; ` +
          `startEvents: markerFound`
        );
        
        contentEntity.appendChild(particle);
      }

      markerEntity.appendChild(contentEntity);

      // 7. Event listeners para tracking con mejor manejo
      markerEntity.addEventListener('markerFound', () => {
        console.log(`‚úÖ Marcador ENCONTRADO: ${marker.name} (${index})`);
        activeMarkers.add(marker.id);
        updateActiveCount();
        
        // Mostrar contenido con delay para suavidad
        setTimeout(() => {
          contentEntity.setAttribute('visible', 'true');
        }, 100);
      });

      markerEntity.addEventListener('markerLost', () => {
        console.log(`‚ùå Marcador PERDIDO: ${marker.name} (${index})`);
        activeMarkers.delete(marker.id);
        updateActiveCount();
        
        // Ocultar contenido inmediatamente
        contentEntity.setAttribute('visible', 'false');
      });

      scene.appendChild(markerEntity);
      console.log(`‚úÖ Marcador ${index + 1} creado: ${marker.name}`);
    });

    console.log(`üéâ Total: ${markers.length} marcadores listos para detectar`);
    console.log(`üìã Muestra estos marcadores a la c√°mara:`);
  }

  function updateActiveCount() {
    document.getElementById('active-markers').textContent = 
      `${activeMarkers.size} de ${markers.length} marcadores activos`;
  }

  // Escuchar mensajes del parent
  window.addEventListener('message', (event) => {
    if (event.data.type === 'LOAD_MARKERS') {
      markers = event.data.markers;
      console.log('üì® Marcadores recibidos:', markers);
      document.getElementById('marker-count').textContent = `${markers.length} marcador(es)`;
      generateMarkers();
    }
  });

  // Iniciar cuando cargue
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(loadMarkers, 1000);
  });
</script>

</body>
</html>
